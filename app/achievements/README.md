# Система достижений

## Обзор

Система достижений теперь использует двухуровневую архитектуру:
- **`achievement_types`** - таблица с типами достижений (шаблоны)
- **`achievements`** - таблица с выданными пользователям достижениями

## Структура базы данных

### Таблица `achievement_types`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `integer` | Первичный ключ |
| `uuid` | `uuid` | Уникальный идентификатор |
| `name` | `varchar` | Название типа достижения |
| `description` | `text` | Описание достижения |
| `category` | `varchar` | Категория (time_based, holiday, program, count, weekly, consecutive) |
| `subcategory` | `varchar` | Подкатегория (morning, night, new_year, milestone, frequency, weeks, months, year) |
| `requirements` | `text` | Требования для получения |
| `icon` | `varchar` | Иконка достижения |
| `points` | `integer` | Количество очков за достижение |
| `is_active` | `boolean` | Активно ли достижение |
| `created_at` | `timestamp` | Дата создания |
| `updated_at` | `timestamp` | Дата обновления |

### Таблица `achievements`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | `integer` | Первичный ключ |
| `uuid` | `uuid` | Уникальный идентификатор |
| `name` | `varchar` | Название (для обратной совместимости) |
| `user_id` | `integer` | ID пользователя |
| `status` | `varchar` | Статус достижения |
| `user_training_id` | `integer` | ID тренировки пользователя |
| `user_program_id` | `integer` | ID программы пользователя |
| `program_id` | `integer` | ID программы |
| `created_at` | `timestamp` | Дата создания |
| `updated_at` | `timestamp` | Дата обновления |
| `achievement_type_id` | `integer` | Ссылка на тип достижения |

## Типы достижений

### 1. Временные достижения (`time_based`)

- **Ранняя пташка** - 5 тренировок с 5 до 8 утра (10 очков)
- **Сова** - 5 тренировок с 21 до 00 (10 очков)

### 2. Праздничные достижения (`holiday`)

- **С Новым годом** - тренировка 1 января (5 очков)
- **Международный женский день** - тренировка 8 марта (5 очков)
- **Мужской день** - тренировка 23 февраля (5 очков)

### 3. Программные достижения (`program`)

- **Мощь и сила** - завершение полной программы (50 очков)

### 4. Количественные достижения (`count`)

- **1 тренировка** - первая тренировка (10 очков)
- **3 тренировки** - третья тренировка (20 очков)
- **5 тренировок** - пятая тренировка (30 очков)
- **7 тренировок** - седьмая тренировка (40 очков)
- **10 тренировок** - десятая тренировка (50 очков)
- **15 тренировок** - пятнадцатая тренировка (75 очков)
- **20 тренировок** - двадцатая тренировка (100 очков)
- **25 тренировок** - двадцать пятая тренировка (125 очков)
- **30 тренировок** - тридцатая тренировка (150 очков)
- **40 тренировок** - сороковая тренировка (200 очков)
- **50 тренировок** - пятидесятая тренировка (250 очков)
- **75 тренировок** - семьдесят пятая тренировка (375 очков)
- **100 тренировок** - сотая тренировка (500 очков)

### 5. Недельные достижения (`weekly`)

- **3 раза в неделю** - 3 тренировки за неделю (40 очков)
- **4 раза в неделю** - 4 тренировки за неделю (50 очков)
- **5 раз в неделю** - 5 тренировок за неделю (60 очков)
- **6 раз в неделю** - 6 тренировок за неделю (70 очков)
- **7 раз в неделю** - 7 тренировок за неделю (80 очков)

### 6. Непрерывные периоды (`consecutive`)

#### Недели (`weeks`)
- **2 недели подряд** - минимум 1 тренировка в неделю 2 недели подряд (20 очков)
- **3 недели подряд** - минимум 1 тренировка в неделю 3 недели подряд (30 очков)
- **4 недели подряд** - минимум 1 тренировка в неделю 4 недели подряд (40 очков)
- **5 недель подряд** - минимум 1 тренировка в неделю 5 недель подряд (50 очков)
- **6 недель подряд** - минимум 1 тренировка в неделю 6 недель подряд (60 очков)
- **7 недель подряд** - минимум 1 тренировка в неделю 7 недель подряд (70 очков)

#### Месяцы (`months`)
- **2 месяца подряд** - минимум 1 тренировка в неделю 2 месяца подряд (100 очков)
- **3 месяца подряд** - минимум 1 тренировка в неделю 3 месяца подряд (150 очков)
- **4 месяца подряд** - минимум 1 тренировка в неделю 4 месяца подряд (200 очков)
- **5 месяцев подряд** - минимум 1 тренировка в неделю 5 месяцев подряд (250 очков)
- **6 месяцев подряд** - минимум 1 тренировка в неделю 6 месяцев подряд (300 очков)
- **7 месяцев подряд** - минимум 1 тренировка в неделю 7 месяцев подряд (350 очков)
- **8 месяцев подряд** - минимум 1 тренировка в неделю 8 месяцев подряд (400 очков)
- **9 месяцев подряд** - минимум 1 тренировка в неделю 9 месяцев подряд (450 очков)
- **10 месяцев подряд** - минимум 1 тренировка в неделю 10 месяцев подряд (500 очков)
- **11 месяцев подряд** - минимум 1 тренировка в неделю 11 месяцев подряд (550 очков)

#### Год (`year`)
- **1 год без перерывов** - минимум 1 тренировка в неделю в течение года (1000 очков)

## API Endpoints

### Типы достижений

- `POST /achievements/types` - Создать новый тип достижения
- `GET /achievements/types` - Получить все типы достижений
- `GET /achievements/types/{uuid}` - Получить тип достижения по UUID
- `PUT /achievements/types/{uuid}` - Обновить тип достижения
- `DELETE /achievements/types/{uuid}` - Удалить тип достижения

### Проверка достижений

- `POST /achievements/check-early-bird/{user_uuid}` - Проверить "Ранняя пташка"
- `POST /achievements/check-night-owl/{user_uuid}` - Проверить "Сова"
- `POST /achievements/check-new-year/{user_uuid}` - Проверить "С Новым годом"
- `POST /achievements/check-womens-day/{user_uuid}` - Проверить "Международный женский день"
- `POST /achievements/check-mens-day/{user_uuid}` - Проверить "Мужской день"
- `POST /achievements/check-power-and-strength/{user_uuid}` - Проверить "Мощь и сила"
- `POST /achievements/check-training-count/{user_uuid}` - Проверить количественные достижения
- `POST /achievements/check-weekly-training/{user_uuid}` - Проверить недельные достижения
- `POST /achievements/check-consecutive-weeks/{user_uuid}` - Проверить достижения за недели
- `POST /achievements/check-consecutive-months/{user_uuid}` - Проверить достижения за месяцы
- `POST /achievements/check-year-without-breaks/{user_uuid}` - Проверить "1 год без перерывов"
- `POST /achievements/check-all/{user_uuid}` - Проверить все достижения

### Достижения пользователей

- `POST /achievements/` - Создать новое достижение
- `GET /achievements/user/{user_uuid}` - Получить все достижения пользователя
- `GET /achievements/{uuid}` - Получить достижение по UUID
- `PUT /achievements/{uuid}` - Обновить достижение
- `DELETE /achievements/{uuid}` - Удалить достижение

## Использование

### Создание типов достижений

```python
from app.achievements.dao import AchievementTypeDAO

# Создать тип достижения
achievement_type = await achievement_type_dao.create_achievement_type(
    name="Ранняя пташка",
    description="Завершить 5 тренировок с 5 до 8 утра",
    category="time_based",
    subcategory="morning",
    requirements="5_trainings_5_8_am",
    points=10
)
```

### Проверка достижений

```python
from app.achievements.service import AchievementService

# Проверить все достижения для пользователя
service = AchievementService(session)
results = await service.check_all_achievements_for_user(user_uuid)
```

### Создание достижения для пользователя

```python
from app.achievements.dao import AchievementDAO

# Создать достижение
achievement = await achievement_dao.create_achievement(
    achievement_type_id=achievement_type.id,
    user_id=user.id,
    user_training_id=training.id
)
```

## Преимущества новой архитектуры

1. **Разделение ответственности**: типы достижений отделены от выданных достижений
2. **Гибкость**: легко добавлять новые типы достижений без изменения структуры
3. **Масштабируемость**: можно создавать множество типов достижений
4. **Производительность**: меньше дублирования данных
5. **Управление**: централизованное управление типами достижений
6. **Очки**: система очков для геймификации
7. **Категоризация**: четкая структура категорий и подкатегорий
