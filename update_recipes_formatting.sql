-- SQL скрипт для добавления переносов строк перед пронумерованными пунктами в поле recipe таблицы recipes
-- 
-- Скрипт добавляет перенос строки (\n) перед каждым пронумерованным пунктом (например, "1.", "2.", "3." и т.д.)
-- если перед ним нет уже переноса строки
--
-- Пример преобразования:
-- "1. Отварить гречку в подсоленной воде до полной готовности. 2. Морковь и болгарский перец нарезать соломкой..."
-- ->
-- "1. Отварить гречку в подсоленной воде до полной готовности.\n2. Морковь и болгарский перец нарезать соломкой..."
--
-- ИНСТРУКЦИЯ ПО ИСПОЛЬЗОВАНИЮ:
-- 1. Сначала выполните проверочный запрос (раскомментируйте его ниже), чтобы увидеть, что будет изменено
-- 2. Если результат корректен, выполните UPDATE запрос
-- 3. Рекомендуется сделать резервную копию таблицы перед выполнением UPDATE

-- Для PostgreSQL
-- Вариант 1: Более точный - добавляет перенос только если перед цифрой есть пробел
UPDATE recipes
SET recipe = regexp_replace(
    recipe,
    '([^\n])(\s+)(\d+\.\s)',  -- Ищем: любой символ кроме переноса строки, затем один или более пробелов, затем цифра с точкой и пробелом
    E'\\1\n\\3',               -- Заменяем: первый символ + перенос строки + цифра с точкой и пробелом
    'g'                        -- Флаг 'g' для замены всех вхождений
)
WHERE recipe IS NOT NULL
  AND recipe ~ '\s+\d+\.';  -- Обновляем только записи, где есть пронумерованные пункты с пробелом перед ними

-- Вариант 2: Более агрессивный - добавляет перенос перед любой цифрой с точкой (если перед ней не перенос строки)
-- Раскомментируйте этот вариант, если первый не покрывает все случаи:
/*
UPDATE recipes
SET recipe = regexp_replace(
    recipe,
    '([^\n])(\s*)(\d+\.\s*)',  -- Ищем: любой символ кроме переноса строки, затем опциональные пробелы, затем цифра с точкой и опциональным пробелом
    E'\\1\n\\3',                -- Заменяем: первый символ + перенос строки + цифра с точкой и пробелом
    'g'                         -- Флаг 'g' для замены всех вхождений
)
WHERE recipe IS NOT NULL
  AND recipe ~ '\d+\.';  -- Обновляем только записи, где есть пронумерованные пункты
*/

-- ============================================================================
-- ПОДСЧЕТ ЗАПИСЕЙ - сколько записей будет обновлено
-- ============================================================================
-- Выполните этот запрос, чтобы узнать количество записей, которые будут обновлены:

/*
SELECT COUNT(*) AS records_to_update
FROM recipes
WHERE recipe IS NOT NULL
  AND recipe ~ '\s+\d+\.';
*/

-- ============================================================================
-- ПРОВЕРОЧНЫЙ ЗАПРОС - выполните его ПЕРЕД UPDATE, чтобы увидеть изменения
-- ============================================================================
-- Раскомментируйте запрос ниже и выполните его, чтобы увидеть, как будут изменены записи:

/*
SELECT 
    id,
    name,
    recipe AS old_recipe,
    regexp_replace(
        recipe,
        '([^\n])(\s+)(\d+\.\s)',
        E'\\1\n\\3',
        'g'
    ) AS new_recipe
FROM recipes
WHERE recipe IS NOT NULL
  AND recipe ~ '\s+\d+\.'
LIMIT 10;
*/

-- Альтернативный проверочный запрос для более агрессивного варианта:
-- SELECT 
--     id,
--     name,
--     recipe AS old_recipe,
--     regexp_replace(
--         recipe,
--         '([^\n])(\s*)(\d+\.\s*)',
--         E'\\1\n\\3',
--         'g'
--     ) AS new_recipe
-- FROM recipes
-- WHERE recipe IS NOT NULL
--   AND recipe ~ '\d+\.'
-- LIMIT 5;

