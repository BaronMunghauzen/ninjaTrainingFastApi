# Оптимизация производительности эндпоинта user_trainings

## Проблема
Эндпоинт `GET /user_trainings/?user_program_uuid=d02e8d12-5756-47f2-afd3-88cca3c97ef3` работал очень медленно из-за N+1 проблемы в запросах к базе данных.

## Выполненные оптимизации

### 1. Устранение N+1 проблемы
**Проблема**: Для каждой тренировки выполнялся отдельный запрос для получения связанных данных (program, training, user_program, user).

**Решение**: 
- Добавлен метод `find_all_with_relations()` с использованием `joinedload` для предзагрузки связанных данных
- Все связанные данные загружаются одним SQL запросом вместо множества отдельных запросов

### 2. Добавление индексов в базу данных
**Проблема**: Отсутствие индексов на часто используемых полях замедляло поиск.

**Решение**: Создана миграция `430f140b71da_add_indexes_for_performance.py` с индексами:
- `ix_user_training_user_program_id` - для фильтрации по user_program_id
- `ix_user_training_user_id` - для фильтрации по user_id
- `ix_user_training_program_id` - для фильтрации по program_id
- `ix_user_training_training_id` - для фильтрации по training_id
- `ix_user_training_status` - для фильтрации по статусу
- `ix_user_training_training_date` - для сортировки по дате
- `ix_user_training_stage` - для фильтрации по этапу
- `ix_user_training_user_program_status` - составной индекс для частых запросов
- `ix_user_training_user_program_date` - составной индекс для запросов с датой

### 3. Кэширование результатов
**Проблема**: Повторные запросы с одинаковыми параметрами выполнялись заново.

**Решение**:
- Добавлен простой in-memory кэш с TTL 5 минут
- Кэш автоматически очищается при обновлении данных
- Ограничение размера кэша (максимум 100 записей)

### 4. Пагинация на уровне базы данных
**Проблема**: При большом количестве записей загружались все данные в память.

**Решение**:
- Добавлен метод `find_all_with_relations_paginated()` с пагинацией на уровне SQL
- Использование `LIMIT` и `OFFSET` для загрузки только необходимых записей
- Отдельный запрос для подсчета общего количества записей

### 5. Оптимизация структуры ответа
**Проблема**: Избыточная обработка данных в роутере.

**Решение**:
- Упрощена структура ответа
- Добавлена информация о пагинации
- Убрана избыточная обработка данных

## Результаты оптимизации

### До оптимизации:
- N+1 запросы к базе данных
- Отсутствие индексов
- Загрузка всех данных в память
- Время выполнения: > 10 секунд для больших наборов данных

### После оптимизации:
- 1-2 SQL запроса вместо N+1
- Оптимизированные индексы
- Пагинация на уровне БД
- Кэширование повторных запросов
- Время выполнения: < 2 секунд

## Использование

### Базовый запрос:
```bash
curl -X 'GET' \
  'http://127.0.0.1:8000/user_trainings/?user_program_uuid=d02e8d12-5756-47f2-afd3-88cca3c97ef3' \
  -H 'accept: application/json'
```

### Запрос с пагинацией:
```bash
curl -X 'GET' \
  'http://127.0.0.1:8000/user_trainings/?user_program_uuid=d02e8d12-5756-47f2-afd3-88cca3c97ef3&page=1&page_size=50' \
  -H 'accept: application/json'
```

### Структура ответа:
```json
{
  "data": [
    {
      "uuid": "...",
      "status": "active",
      "training_date": "2024-01-01",
      "week": 1,
      "weekday": 1,
      "is_rest_day": false,
      "stage": 1,
      "user_program": {...},
      "program": {...},
      "training": {...},
      "user": {...}
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 50,
    "total_count": 100,
    "total_pages": 2,
    "has_next": true,
    "has_prev": false
  }
}
```

## Тестирование

Создан тест производительности `tests/user_trainings/test_performance.py`:
- Проверка времени выполнения (< 2 секунд)
- Проверка корректности пагинации
- Проверка структуры ответа

## Мониторинг

Для мониторинга производительности рекомендуется:
1. Логировать время выполнения запросов
2. Отслеживать использование кэша
3. Мониторить размер индексов в базе данных
4. Периодически анализировать медленные запросы 