# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–æ–∫

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

–í—Å—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:

1. ‚úÖ –°–æ–∑–¥–∞–Ω—ã –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (SubscriptionPlan, Payment, Subscription)
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –¢–æ—á–∫–∞ API
3. ‚úÖ –°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã API endpoints
5. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å User
6. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
7. ‚úÖ –†–æ—É—Ç–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `.env` –∏ –¥–æ–±–∞–≤—å—Ç–µ/–æ–±–Ω–æ–≤–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¢–æ—á–∫–∞ –ë–∞–Ω–∫
TOCHKA_ACCESS_TOKEN=your_jwt_token_here
TOCHKA_API_URL=https://api.tochka.com/v1
TOCHKA_VAT_CODE=vat20

# URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤)
BASE_URL=http://localhost:8000
```

**–ö—É–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—å JWT-—Ç–æ–∫–µ–Ω:**
- –ó–∞–º–µ–Ω–∏—Ç–µ `your_jwt_token_here` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π JWT-—Ç–æ–∫–µ–Ω –æ—Ç –¢–æ—á–∫–∏
- –¢–æ–∫–µ–Ω –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢–æ—á–∫–∏: https://enter.tochka.com/

**–í–∞–∂–Ω–æ –ø—Ä–æ BASE_URL:**
- –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å `http://localhost:8000`
- –î–ª—è —Ä–∞–±–æ—Ç—ã –≤–µ–±—Ö—É–∫–æ–≤ –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π URL (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok)
- –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω —Å HTTPS

---

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ
.\.venv\Scripts\Activate.ps1

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã:
- `subscription_plans` - —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
- `payments` - –ø–ª–∞—Ç–µ–∂–∏
- `subscriptions` - –ø–æ–¥–ø–∏—Å–∫–∏
- –î–æ–±–∞–≤–∏—Ç –ø–æ–ª—è `trial_used` –∏ `trial_started_at` –≤ —Ç–∞–±–ª–∏—Ü—É `user`

---

### 3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

```bash
python create_subscription_plans.py
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç 4 —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –ø–ª–∞–Ω–∞:
- 1 –º–µ—Å—è—Ü - 990‚ÇΩ
- 3 –º–µ—Å—è—Ü–∞ - 2490‚ÇΩ (–≤—ã–≥–æ–¥–∞ 16%)
- 6 –º–µ—Å—è—Ü–µ–≤ - 4490‚ÇΩ (–≤—ã–≥–æ–¥–∞ 24%)
- 12 –º–µ—Å—è—Ü–µ–≤ - 7990‚ÇΩ (–≤—ã–≥–æ–¥–∞ 33%)

**–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—ã:**
–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `create_subscription_plans.py` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º.

---

### 4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

```bash
uvicorn app.main:app --reload
```

–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ `http://localhost:8000`

---

### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É API

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```
http://localhost:8000/docs
```

–í—ã —É–≤–∏–¥–∏—Ç–µ Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å–æ –≤—Å–µ–º–∏ –Ω–æ–≤—ã–º–∏ endpoints:
- `GET /api/subscriptions/plans` - —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤
- `POST /api/subscriptions/activate-trial` - –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ç—Ä–∏–∞–ª–∞
- `POST /api/subscriptions/purchase` - –ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- `GET /api/subscriptions/status` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
- `GET /api/subscriptions/payment/{uuid}/status` - —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
- `GET /api/subscriptions/history` - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- `POST /api/subscriptions/webhook` - –≤–µ–±—Ö—É–∫ –æ—Ç –¢–æ—á–∫–∏

---

### 6. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ù–∞—Å—Ç—Ä–æ–π—Ç–µ ngrok –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–µ–±—Ö—É–∫–æ–≤

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–µ–±—Ö—É–∫–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok: https://ngrok.com/download
ngrok http 8000
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://abc123.ngrok.io`) –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –≤ `.env`:
```env
BASE_URL=https://abc123.ngrok.io
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤

```bash
curl http://localhost:8000/api/subscriptions/plans
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑ 4 —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤.

### –¢–µ—Å—Ç 2: –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç—Ä–∏–∞–ª–∞ (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

```bash
curl -X POST http://localhost:8000/api/subscriptions/activate-trial \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### –¢–µ—Å—Ç 3: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (—Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

```bash
curl -X POST http://localhost:8000/api/subscriptions/purchase \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"plan_id": 1}'
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `payment_url` –¥–ª—è –æ–ø–ª–∞—Ç—ã.

---

## üì± –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

### –û—Å–Ω–æ–≤–Ω–æ–π flow:

1. **–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–æ–≤**
   ```typescript
   GET /api/subscriptions/plans
   ```

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ**
   
3. **–°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂–Ω—É—é —Å—Å—ã–ª–∫—É**
   ```typescript
   POST /api/subscriptions/purchase
   Body: { plan_id: 1 }
   ```

4. **–û—Ç–∫—Ä—ã—Ç—å payment_url –≤ –±—Ä–∞—É–∑–µ—Ä–µ**
   ```typescript
   Linking.openURL(payment_url)
   ```

5. **–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å Deep Link**
   ```typescript
   // myapp://payment/callback?payment_uuid=xxx
   ```

6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞**
   ```typescript
   GET /api/subscriptions/payment/{payment_uuid}/status
   ```

7. **–û–±–Ω–æ–≤–∏—Ç—å UI**

–ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ - –≤ —Ñ–∞–π–ª–µ `app/subscriptions/README.md`

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Deep Links

### React Native:

```typescript
// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã
Linking.addEventListener('url', handleDeepLink);

const handleDeepLink = async ({ url }: { url: string }) => {
  if (url.startsWith('myapp://payment/callback')) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –æ–ø–ª–∞—Ç—ã
    const payment_uuid = extractPaymentUUID(url);
    await checkPaymentStatus(payment_uuid);
  }
};
```

### Android (AndroidManifest.xml):

```xml
<intent-filter>
  <action android:name="android.intent.action.VIEW" />
  <category android:name="android.intent.category.DEFAULT" />
  <category android:name="android.intent.category.BROWSABLE" />
  <data android:scheme="myapp" android:host="payment" />
</intent-filter>
```

### iOS (Info.plist):

```xml
<key>CFBundleURLTypes</key>
<array>
  <dict>
    <key>CFBundleURLSchemes</key>
    <array>
      <string>myapp</string>
    </array>
  </dict>
</array>
```

---

## üéØ –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

- [ ] –ü–æ–ª—É—á–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π JWT-—Ç–æ–∫–µ–Ω –æ—Ç –¢–æ—á–∫–∏
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—ç–∫–≤–∞–π—Ä–∏–Ω–≥ –≤ –¢–æ—á–∫–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω HTTPS –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏
- [ ] –°–æ–∑–¥–∞–Ω—ã —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
- [ ] –í–µ–±—Ö—É–∫–∏ –¥–æ—Ö–æ–¥—è—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–ø–ª–∞—Ç—ã
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã Deep Links –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–æ–≥–æ–≤–æ—Ä –æ—Ñ–µ—Ä—Ç—ã
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¢–æ—á–∫–∞ API: https://developers.tochka.com/docs/tochka-api/
- –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¢–æ—á–∫–∏: https://enter.tochka.com/
- –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è: `app/subscriptions/README.md`
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ò–ü/–û–û–û: https://www.nalog.gov.ru/

---

## ‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**Q: –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å JWT-—Ç–æ–∫–µ–Ω?**
A: –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢–æ—á–∫–∏ ‚Üí –†–∞–∑–¥–µ–ª API ‚Üí –°–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω

**Q: –ù—É–∂–Ω–∞ –ª–∏ –æ–Ω–ª–∞–π–Ω-–∫–∞—Å—Å–∞?**
A: –ù–µ—Ç! –¢–æ—á–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏—Å–∫–∞–ª–∏–∑–∏—Ä—É–µ—Ç —á–µ–∫–∏ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—ë–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏.

**Q: –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –±–µ–∑ PCI DSS?**
A: –î–∞! –ü–ª–∞—Ç—ë–∂–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –¢–æ—á–∫–∏.

**Q: –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π?**
A: –¢–æ—á–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç sandbox-–æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

**Q: –í–µ–±—Ö—É–∫–∏ –Ω–µ –¥–æ—Ö–æ–¥—è—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å?**
A: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ BASE_URL –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏).

**Q: –ú–æ–∂–Ω–æ –ª–∏ –º–µ–Ω—è—Ç—å —Ü–µ–Ω—ã?**
A: –î–∞, –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `create_subscription_plans.py` –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —á–µ—Ä–µ–∑ SQL.

---

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `.env`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ JWT-—Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π
5. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–µ–π –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢–æ—á–∫–∏

–£–¥–∞—á–∏ —Å –∑–∞–ø—É—Å–∫–æ–º! üöÄ
